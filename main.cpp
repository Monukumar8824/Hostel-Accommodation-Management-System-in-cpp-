#include <iostream>
#include <fstream>
#include <string>
#include <cstring>
#include <windows.h>
#include <conio.h>
#include <cstdlib>
#include <limits>
#include <ctime>
#include <iomanip>
#include "StudentRecord.h"
#include "Student.h"
#include "Room.h"
#include "Fee.h"
#include "Visitor.h"
#include "Security.h"
#include "student_login.h"

using namespace std;

class Visitor;
class Security;
class Student;
class Room;
class Fee;
class student_login;


class User  {
    int Id;
    char username[30];
    char password[30];
    char Full_name[100];
    char phone_number[100];
    char Adhaar_no[100];
    char Address[100];
    public:

    User()
    {   Id=345;
        strcpy(username, "monu");
        strcpy(password, "12");
        strcpy(Full_name, "Monu");
        strcpy(phone_number, "1234567890");
        strcpy(Adhaar_no, "123456789012");
        strcpy(Address, "123 Main St, City, Country");
        
    }
    
    string getUsername() {
        
        string str = string(username);
        return str;
    }
    
    string getPassword() {
        string pass = string(password);
        return pass;
    }
    
    void input() {
        
        cout << "Enter User Id: ";
        cin >> Id;
        cin.ignore();  
        
        cout << "Enter User Name: ";
        cin.getline(username, 30);
        cout << "Enter Password: ";
        int i =0;
        char ch;
        while ((ch = _getch()) != 13 && i<29) {
            if (ch == 8 && i>0) {  //backspace
                cout << "\b \b";
                i--;

            } else if (ch!=8) {
                password[i++] = ch;
                cout << ch;
            }
        }
        password[i] = '\0';
        cout << endl;
        cout << "Enter Full Name: ";
        cin.getline(Full_name, 100);
        cout << "Enter Phone Number: ";
        cin.getline(phone_number, 100);
        cout << "Enter Adhaar Number: ";
        cin.getline(Adhaar_no, 100);
        cout << "Enter Address: ";
        cin.getline(Address, 100);

    }
void display() {
    

    cout << "| "
         << left << setw(7) << Id << " | "
         << left << setw(16) << username << " | "
         << left << setw(16) << password << " | "
         << left << setw(24) << Full_name << " | "
         << left << setw(17) << phone_number << " | "
         << left << setw(19) << Adhaar_no << " | "
         << left << setw(26) << Address << " |\n";
    
} 
void createDefaultUserIfNotExists() {
    fstream f;
    f.open("User_test.dat", ios::in | ios::binary);
    if (!f) {
        // File nahi hai, to create karo aur default user daalo
        f.close();
        User defaultUser; // constructor se initialized
        f.open("User_test.dat", ios::out | ios::binary);
        f.write((char*)&defaultUser, sizeof(defaultUser));
        f.close();
        cout << "Default user added to file.\n";
    } else {
        f.close();
        // File already exists, kuch nahi karna
    }
}

    void addUser() {
        User u;
        fstream f;
        int newId;
        cout << "Enter User Id: ";
        cin >> newId;
        cin.ignore();

        bool found = false;
        f.open("User_test.dat", ios::in | ios::binary);
        if (f) {
            User temp;
            while (f.read((char*)&temp, sizeof(temp)))  {
                if (temp.Id == newId)  {
                    found = true;
                    break;
                }
            }
            f.close();
        }

        if (found) {
            cout << " User ID already exits. now we cannot add of this ID..\n";
            return;
        }
        u.Id = newId;
        f.open("User_test.dat", ios::app | ios::binary );
        cin.ignore();
        u.input();
        f.write((char*)&u, sizeof(u));
        f.close();
        cout <<"User ID:- "<< u.Id << "  Got Added Successfully..\n";

    }

    void viewUser() {
        User u;
        fstream f;
        f.open("User_test.dat", ios::in | ios::binary);
        if(!f) {
            cout << "No User found.\n";
            f.close();
            return;
        }
        cout << "+---------+------------------+------------------+--------------------------+-------------------+---------------------+----------------------------+\n";
        cout << "| User ID | User Name        | Password         | Full Name                | Phone Number      | Aadhaar Number      | Address                    |\n";
        cout << "+---------+------------------+------------------+--------------------------+-------------------+---------------------+----------------------------+\n";
        while(f.read((char*)&u,sizeof(u))) {
            u.display();
        }
       cout << "+---------+------------------+------------------+--------------------------+-------------------+---------------------+----------------------------+\n";
     f.close();
    }

    void updateUser() {
    fstream f;
    User u;
    int id;
    bool found = false;

    cout << "Enter User Id To Update: ";
    cin >> id;

    f.open("User_test.dat", ios::in | ios::out | ios::binary);
    if (!f) {
        cout << "Can not open file.\n";
        return;
    }

    while (f.read((char*)&u, sizeof(u))) {
        if (u.Id == id) {
            
            cout << "\nExisting Record:\n";
            cout << "+---------+------------------+------------------+--------------------------+-------------------+---------------------+----------------------------+\n";
            cout << "| User ID | User Name        | Password         | Full Name                | Phone Number      | Aadhaar Number      | Address                    |\n";
            cout << "+---------+------------------+------------------+--------------------------+-------------------+---------------------+----------------------------+\n";
            u.display();
            cout << "+---------+------------------+------------------+--------------------------+-------------------+---------------------+----------------------------+\n";
            cout << "\nEnter new details:\n";
            u.input();
            
            int pos = f.tellg();
            f.seekp (pos - sizeof(u), ios::beg);

            f.write((char*)&u, sizeof(u));

            cout <<"User ID:- "<< u.Id << "  Record Successfully Updated.\n";
            found = true;
            break;
        }
    }

    if (!found) {
        cout << "User Id not found.\n";
    }

    f.close();
}

void deleteUser()  {
    User u;
    int id;
    bool found = false;

    cout << "Enter User ID to delete: ";
    cin >> id;
    fstream f1, f2;
    f1.open("User_test.dat", ios::in | ios::binary);
    f2.open("temp.dat", ios::out | ios::binary );
    if (!f1 || !f2 ) {
        cout << "Can not open file.\n";
        f1.close();
        f2.close();
        return;
    }
    while(f1.read((char*)&u, sizeof(u))) {
        if (u.Id != id)  {
            f2.write((char*)&u, sizeof(u));
        } else {
            found = true;
        }
    }
        f1.close();
        f2.close();
        remove("User_test.dat");
        rename("temp.dat", "User_test.dat");

        if (found) 
         cout << "User ID:-  " << id << " Deleted Successfully..\n";
        else 
          cout << "User Id Not Found.\n"; 

    
}


void userManagementMenu() {
    User u;
    int choice;
    do {
        system("cls");
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n                                                               USER   MANAGEMENT                                                                                               \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "1. ADD USER\n";
        cout << "2. VIEW USER\n";
        cout << "3. UPDATE USER\n";
        cout << "4. DELETE USER\n";
        cout << "5. BACK TO MAIN MENU\n";
        cout << "\033[1;36m\n===============================================================================================================================================================================\033[0m\n";
        cout << "ENTER YOUR CHOICE: ";
        cin >> choice;
        cin.ignore();
                
                switch (choice) {
                        system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                               USER   MANAGEMENT                                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                    
                case 1: cout << "1.  *********************  ADD USER    ********************* \n";
                        addUser();
                        break;
                        system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                               USER   MANAGEMENT                                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";        
                case 2: cout << "2.  *********************  VIEW USER    *********************\n ";
                        viewUser(); 
                        break;
                        system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                               USER   MANAGEMENT                                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";                
                case 3: cout << "3.  *********************  UPDATE USER   *********************\n ";
                        updateUser(); 
                        break;
                        system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                               USER   MANAGEMENT                                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";    
                case 4: cout << "4.  *********************  DELETE USER    *********************\n ";
                        deleteUser();
                        break;
                case 5: return;
                
                default: cout << "Invalid choice.\n";

        }
        system("pause");
    } while(choice!=5);
}



bool validate_login(char Name[30], char Password[30]) {
    fstream f;
    User u;
    f.open("User_test.dat", ios :: in | ios::binary);
    if (!f) {
        cout << "Can not open file." << endl;
        f.close();
        return false;
    }
    while(f.read((char*)&u, sizeof(u))) {
        if (strcmp(u.username, Name) == 0 && strcmp(u.password, Password) == 0) {

        // if (username == Name && password ==Password) {
            cout << "\n Successful";
            f.close();
            return true;
        }
    }
    f.close();
    return false;
}

    bool login() {
    int choice;
    student_login auth;
    char Name[30];
    char Password[30];
    while(true) {
    system("cls");
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n                                                               WELCOME TO THE LOGIN ACCOUNT                                                                                    \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "1. LOGIN AS ADMIN: " << endl;
        cout << "2. LOGIN AS STUDENT: " << endl;
        cout << "3. EXIT: " << endl;
        cout << "\033[1;36m\n===============================================================================================================================================================================\033[0m\n";
        cout << "ENTER YOUR CHOICE: ";
        cin >> choice;
        system("cls");
        cin.ignore();
        if (choice == 1) {
            system("cls");
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n                                                               WELCOME TO THE ADMIN LOGIN ACCOUNT                                                                              \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "Enter the Username : ";
        cin.getline(Name, 30);

        cout << "Enter the Password : ";
        int index = 0;
        char ch;

        while ((ch = _getch()) != 13) {
        if (ch == 8) { // Backspace
            if (index > 0) {
                index--;
                cout << "\b \b"; // Erase
            }
        } else if (index < 19 && ch >= 32 && ch <= 126) {
            Password[index++] = ch;
            cout << "*"; // for printing * at run time to hide password
        }
       }
       Password[index] = '\0';
       if (validate_login(Name, Password)) {
        for (int i = 3; i > 0; i--) {
            system("cls");  // Clear screen
            cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
            cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
            cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
            cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
            cout << "\033[1;34m\n                                                               WELCOME TO THE ADMIN LOGIN ACCOUNT                                                                              \033[0m\n";
            cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
            cout << "Login Successful! Welcome, " << Name << "." << endl;
            cout << "Redirecting to Main Menu in " << i << "..." << endl;
            Sleep(1000);  // Wait 1 second

        }
        subLogin();

        system("cls");  // Clear screen again before showing menu
       
     }  else {
        cout << "\nInvalid Username or Password. Access denied." << endl;
        Sleep(2000);
     }

}

     else if (choice == 2) {
        const string id;
        const string nm;

        system("cls");
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n                                                              WELCOME TO THE STUDENT LOGIN ACCOUNT                                                                             \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        auth.login();   
        Sleep(2000);
        login();
     }

    else {
        system("cls");
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "\033[1;34m\n                                                              WELCOME TO THE EXIT                                                                                              \033[0m\n";
        cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
        cout << "Invalid choice. please try again.\n";
        Sleep(2000);
    }

   }
}

void subLogin(){
    int choice; // Declare choice outside the loop
    User uj;
    Student st;
    Room rm;
    Fee fe;
    Visitor vs;
    Security sc;
    MessMenu mn;
    do{
        system("cls");
cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
cout << "\033[1;34m\n                                                                WELCOME TO THE MENU BAR                                                                                        \033[0m\n";
cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
cout << "1. USER MANAGEMENT\n";
cout << "2. STUDENT MANAGEMENT\n";
cout << "3. ROOM MANAGEMENT\n";
cout << "4. FEE MANAGEMENT\n";
cout << "5. SECURITY MANAGEMENT\n";
cout << "6. VISITOR MANAGEMENT\n";
cout << "7. MESS MANAGEMENT\n";
cout << "8. EXIT\n";
cout << "\033[1;36m\n===============================================================================================================================================================================\033[0m\n";
cout << "ENTER YOUR CHOICE: ";
cin >> choice;

    switch(choice) {
                system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                                 USER  MANAGEMENT                                                                                              \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
    case 1:     userManagementMenu(); 
                break;
                system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                                  STUDENT  MANAGEMENT                                                                                          \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
    case 2:     st.studentManagementMenu(); 
                break;
                system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                                    ROOM   MANAGEMENT                                                                                          \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
    case 3:     rm.roomManagementMenu(); 
                break;
                system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                                     FEE   MANAGEMENT                                                                                          \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
    case 4:     fe.feeManagementMenu(); 
                break;
                system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                                 SECURITY  MANAGEMENT                                                                                          \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
    case 5:     sc.securityManagementMenu(); 
                break;
                system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                                 VISITOR  MANAGEMENT                                                                                            \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
    case 6:     vs.visitorManagementMenu(); 
                break;
                system("cls");
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n\n                                                        HOSTEL ACCOMMODATION MANAGEMENT SYSTEM                                                                               \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
                cout << "\033[1;34m\n                                                                   MESS  MANAGEMENT                                                                                            \033[0m\n";
                cout << "\033[1;33m\n===============================================================================================================================================================================\033[0m\n";
    case 7:     mn.messManagementMenu();      
    case 8:     cout << "Exit\n"; 
                break;
        default: cout << "Invalid choice.\n";
    }
    system("pause");
 } while(choice != 8);

}


};

int main() {
    User u;
    u.createDefaultUserIfNotExists();
     while (true) {
        bool (k) = u.login();
       
        if (k) 
          break;

        cout << "Do you want to try login again.. (Y/N): ";
        char ch;
        cin >> ch;
        if (ch == 'N' || ch == 'n')  
           break;
        cin.ignore();   

     }

     return 0;

}

